<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>VolD: server/src/main/java/de/zib/vold/backend/BabuDirectory.java Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = '../../open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = '../../closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">VolD&#160;<span id="projectnumber">0.1</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Packages</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d7/d6d/BabuDirectory_8java.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>BabuDirectory.java</h1>  </div>
</div>
<div class="contents">
<a href="../../d7/d6d/BabuDirectory_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a><a class="code" href="../../db/db1/namespacede_1_1zib_1_1vold_1_1backend.html">00002</a> <span class="keyword">package </span>de.zib.vold.backend;
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="keyword">import</span> de.zib.vold.common.VoldException;
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="keyword">import</span> java.util.Map.Entry;
<a name="l00007"></a>00007 <span class="keyword">import</span> java.util.List;
<a name="l00008"></a>00008 <span class="keyword">import</span> java.util.LinkedList;
<a name="l00009"></a>00009 <span class="keyword">import</span> java.util.Map;
<a name="l00010"></a>00010 <span class="keyword">import</span> java.util.HashMap;
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="keyword">import</span> java.util.Properties;
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="keyword">import</span> java.io.UnsupportedEncodingException;
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="keyword">import</span> org.xtreemfs.babudb.*;
<a name="l00017"></a>00017 <span class="keyword">import</span> org.xtreemfs.babudb.api.database.*;
<a name="l00018"></a>00018 <span class="keyword">import</span> org.xtreemfs.babudb.config.*;
<a name="l00019"></a>00019 <span class="keyword">import</span> org.xtreemfs.babudb.api.*;
<a name="l00020"></a>00020 <span class="keyword">import</span> org.xtreemfs.babudb.api.exception.*;
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keyword">import</span> javax.annotation.PostConstruct;
<a name="l00023"></a>00023 <span class="keyword">import</span> javax.annotation.PreDestroy;
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">import</span> org.slf4j.Logger;
<a name="l00026"></a>00026 <span class="keyword">import</span> org.slf4j.LoggerFactory;
<a name="l00027"></a>00027 
<a name="l00043"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html">00043</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html" title="Implementation of PartitionedDirectoryBackend based on BabuDB.">BabuDirectory</a> <span class="keyword">implements</span> <a class="code" href="../../d0/d6a/interfacede_1_1zib_1_1vold_1_1backend_1_1PartitionedDirectoryBackend.html" title="Interface for directory backends.">PartitionedDirectoryBackend</a>
<a name="l00044"></a>00044 {
<a name="l00045"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">00045</a>         <span class="keyword">private</span> Properties <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a>;
<a name="l00046"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">00046</a>         <span class="keyword">private</span> String <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">dbname</a>;
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">00048</a>         <span class="keyword">private</span> String <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a>;
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a117d10e81e82e30311c0cfc021ad67f9">00050</a>         <span class="keyword">private</span> BabuDB <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a117d10e81e82e30311c0cfc021ad67f9">babudb</a>;
<a name="l00051"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a10b58bc5d127ec95d460b8b21cfa1c7a">00051</a>         <span class="keyword">private</span> Database <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a10b58bc5d127ec95d460b8b21cfa1c7a">db</a>;
<a name="l00052"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae4d2f4e90a3c48219db1cd027a8cb708">00052</a>         <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae4d2f4e90a3c48219db1cd027a8cb708">opened</a>;
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">00054</a>         <span class="keyword">protected</span> <span class="keyword">final</span> Logger <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a> = LoggerFactory.getLogger( this.getClass() );
<a name="l00055"></a>00055 
<a name="l00068"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#abf33475eb25ae4d90941465a7c7f522d">00068</a>         <span class="keyword">public</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#aad41907d462fdaaadb93508184fe1397" title="Construct a BabuDirectory without initialization.">BabuDirectory</a>( String basedir, String logdir, String sync, String databasename, String encoding )
<a name="l00069"></a>00069         {
<a name="l00070"></a>00070                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a> = <span class="keyword">new</span> java.util.Properties();
<a name="l00071"></a>00071 
<a name="l00072"></a>00072                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a>.setProperty( <span class="stringliteral">&quot;babudb.baseDir&quot;</span>, basedir );
<a name="l00073"></a>00073                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a>.setProperty( <span class="stringliteral">&quot;babudb.logDir&quot;</span>, logdir );
<a name="l00074"></a>00074                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a>.setProperty( <span class="stringliteral">&quot;babudb.sync&quot;</span>, sync );
<a name="l00075"></a>00075 
<a name="l00076"></a>00076                 this.<a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">dbname</a> = databasename;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae4d2f4e90a3c48219db1cd027a8cb708">opened</a> = <span class="keyword">false</span>;
<a name="l00079"></a>00079                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a> = encoding;
<a name="l00080"></a>00080         }
<a name="l00081"></a>00081 
<a name="l00085"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#aad41907d462fdaaadb93508184fe1397">00085</a>         <span class="keyword">public</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#aad41907d462fdaaadb93508184fe1397" title="Construct a BabuDirectory without initialization.">BabuDirectory</a>( )
<a name="l00086"></a>00086         {
<a name="l00087"></a>00087                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a> = <span class="keyword">new</span> java.util.Properties();
<a name="l00088"></a>00088 
<a name="l00089"></a>00089                 this.<a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">dbname</a> = null;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae4d2f4e90a3c48219db1cd027a8cb708">opened</a> = <span class="keyword">false</span>;
<a name="l00092"></a>00092                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a> = <span class="stringliteral">&quot;utf-8&quot;</span>;
<a name="l00093"></a>00093         }
<a name="l00094"></a>00094 
<a name="l00105"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#afebf690c82f1379383b72216b82b91ed">00105</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#afebf690c82f1379383b72216b82b91ed" title="Set a BabuDirectory property.">setProperty</a>( String key, String value )
<a name="l00106"></a>00106         {
<a name="l00107"></a>00107                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a>.setProperty( key, value );
<a name="l00108"></a>00108         }
<a name="l00109"></a>00109 
<a name="l00115"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a6b9f772ea2ad074b9293336c5ec26dfe">00115</a>         <span class="keyword">public</span> String <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a6b9f772ea2ad074b9293336c5ec26dfe" title="Get a BabuDirectory property.">getProperty</a>( String key )
<a name="l00116"></a>00116         {
<a name="l00117"></a>00117                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a>.getProperty( key );
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119 
<a name="l00127"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae0a594216594c56de586c887ee359a13">00127</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae0a594216594c56de586c887ee359a13" title="Set the base directory BabuDB should use.">setDir</a>( String dir )
<a name="l00128"></a>00128         {
<a name="l00129"></a>00129                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#afebf690c82f1379383b72216b82b91ed" title="Set a BabuDirectory property.">setProperty</a>( <span class="stringliteral">&quot;babudb.baseDir&quot;</span>, dir );
<a name="l00130"></a>00130         }
<a name="l00131"></a>00131 
<a name="l00139"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a34a7f3df43948662d87ee6263d143231">00139</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a34a7f3df43948662d87ee6263d143231" title="Set the log directory BabuDB should use.">setLogDir</a>( String logDir )
<a name="l00140"></a>00140         {
<a name="l00141"></a>00141                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#afebf690c82f1379383b72216b82b91ed" title="Set a BabuDirectory property.">setProperty</a>( <span class="stringliteral">&quot;babudb.logDir&quot;</span>, logDir );
<a name="l00142"></a>00142         }
<a name="l00143"></a>00143 
<a name="l00159"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a74f7b06855341e000582589cc25dc3a4">00159</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a74f7b06855341e000582589cc25dc3a4" title="Set the sync method BabuDB should use.">setSync</a>( String sync )
<a name="l00160"></a>00160         {
<a name="l00161"></a>00161                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#afebf690c82f1379383b72216b82b91ed" title="Set a BabuDirectory property.">setProperty</a>( <span class="stringliteral">&quot;babudb.sync&quot;</span>, sync );
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163 
<a name="l00176"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a3dcae4c2c6844ed22ba15aae9537c56a">00176</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a3dcae4c2c6844ed22ba15aae9537c56a" title="Set the database name for BabuDB.">setDatabaseName</a>( String databasename )
<a name="l00177"></a>00177         {
<a name="l00178"></a>00178                 this.<a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">dbname</a> = databasename;
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180 
<a name="l00190"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#acea8040a02a5ef271f3eb1e887c3bc8b">00190</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#acea8040a02a5ef271f3eb1e887c3bc8b" title="Set the encoding BabuDB should use.">setEnc</a>( String <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a> )
<a name="l00191"></a>00191         {
<a name="l00192"></a>00192                 this.enc = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a>;
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194 
<a name="l00202"></a>00202         @Override
<a name="l00203"></a>00203         @PostConstruct
<a name="l00204"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a77a42c03e62f460c9c92288aeb4b9b62">00204</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a77a42c03e62f460c9c92288aeb4b9b62" title="Open the database.">open</a>( )
<a name="l00205"></a>00205         {
<a name="l00206"></a>00206                 <span class="comment">// guard</span>
<a name="l00207"></a>00207                 {
<a name="l00208"></a>00208                         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf" title="Query the state of the database.">isopen</a>() )
<a name="l00209"></a>00209                         {
<a name="l00210"></a>00210                                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.warn( <span class="stringliteral">&quot;BabuDirectory: tried to open database twice!&quot;</span> );
<a name="l00211"></a>00211                                 <span class="keywordflow">return</span>;
<a name="l00212"></a>00212                         }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214                         <span class="keywordflow">if</span>(
<a name="l00215"></a>00215                                 null == <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">dbname</a> ||
<a name="l00216"></a>00216                                 null == <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a6b9f772ea2ad074b9293336c5ec26dfe" title="Get a BabuDirectory property.">getProperty</a>( <span class="stringliteral">&quot;babudb.baseDir&quot;</span> ) ||
<a name="l00217"></a>00217                                 null == <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a6b9f772ea2ad074b9293336c5ec26dfe" title="Get a BabuDirectory property.">getProperty</a>( <span class="stringliteral">&quot;babudb.logDir&quot;</span> ) ||
<a name="l00218"></a>00218                                 null == <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a6b9f772ea2ad074b9293336c5ec26dfe" title="Get a BabuDirectory property.">getProperty</a>( <span class="stringliteral">&quot;babudb.sync&quot;</span> )
<a name="l00219"></a>00219                                 )
<a name="l00220"></a>00220                         {
<a name="l00221"></a>00221                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( <span class="stringliteral">&quot;Need to proper initialize BabuDirectory before opening it! Necessary is setting dir (base directory to store files, created by BabuDB), logDir (directory where logfiles are stored), sync (sync method, see BabuDB docs) and database name.&quot;</span> );
<a name="l00222"></a>00222                         }
<a name="l00223"></a>00223                 }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225                 <span class="comment">// create new instance of a babuDB</span>
<a name="l00226"></a>00226                 {
<a name="l00227"></a>00227                         <span class="keywordflow">try</span>
<a name="l00228"></a>00228                         {
<a name="l00229"></a>00229                                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a117d10e81e82e30311c0cfc021ad67f9">babudb</a> = BabuDBFactory.createBabuDB( <span class="keyword">new</span> BabuDBConfig( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a648ce506c431f41d477265fb9a280917">props</a> ) );
<a name="l00230"></a>00230                         }
<a name="l00231"></a>00231                         <span class="keywordflow">catch</span>( java.io.IOException e )
<a name="l00232"></a>00232                         {
<a name="l00233"></a>00233                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e );
<a name="l00234"></a>00234                         }
<a name="l00235"></a>00235                         <span class="keywordflow">catch</span>( BabuDBException e )
<a name="l00236"></a>00236                         {
<a name="l00237"></a>00237                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e );
<a name="l00238"></a>00238                         }
<a name="l00239"></a>00239                 }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241                 DatabaseManager manager = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a117d10e81e82e30311c0cfc021ad67f9">babudb</a>.getDatabaseManager ();
<a name="l00242"></a>00242 
<a name="l00243"></a>00243                 <span class="comment">// open database</span>
<a name="l00244"></a>00244                 {
<a name="l00245"></a>00245                         <span class="keywordflow">try</span>
<a name="l00246"></a>00246                         {
<a name="l00247"></a>00247                                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a10b58bc5d127ec95d460b8b21cfa1c7a">db</a> = manager.getDatabase( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">dbname</a> );
<a name="l00248"></a>00248                         }
<a name="l00249"></a>00249                         <span class="keywordflow">catch</span>( BabuDBException e )
<a name="l00250"></a>00250                         {
<a name="l00251"></a>00251                                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.info( <span class="stringliteral">&quot;BabuDirectory could not open database: &quot;</span> + e.getMessage() );
<a name="l00252"></a>00252                                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.info( <span class="stringliteral">&quot;BabuDirectory will try to create it...&quot;</span> );
<a name="l00253"></a>00253 
<a name="l00254"></a>00254                                 <span class="keywordflow">try</span>
<a name="l00255"></a>00255                                 {
<a name="l00256"></a>00256                                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a10b58bc5d127ec95d460b8b21cfa1c7a">db</a> = manager.createDatabase( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#af8cf392d067e67b9f75d0d1c0380abde">dbname</a>, 3 );
<a name="l00257"></a>00257                                 }
<a name="l00258"></a>00258                                 <span class="keywordflow">catch</span>( BabuDBException e2 )
<a name="l00259"></a>00259                                 {
<a name="l00260"></a>00260                                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e2 );
<a name="l00261"></a>00261                                 }
<a name="l00262"></a>00262                         }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae4d2f4e90a3c48219db1cd027a8cb708">opened</a> = <span class="keyword">true</span>;
<a name="l00265"></a>00265                 }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.info( <span class="stringliteral">&quot;BabuDirectory opened.&quot;</span> );
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269 
<a name="l00277"></a>00277         @Override
<a name="l00278"></a>00278         @PreDestroy
<a name="l00279"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a9dde824bf5a731a153fd98ae818f7328">00279</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a9dde824bf5a731a153fd98ae818f7328" title="Close the database.">close</a>( )
<a name="l00280"></a>00280         {
<a name="l00281"></a>00281                 <span class="keywordflow">if</span>( ! <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf" title="Query the state of the database.">isopen</a>() )
<a name="l00282"></a>00282                 {
<a name="l00283"></a>00283                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.warn( <span class="stringliteral">&quot;Tried to close database while it wasn&#39;t open&quot;</span> );
<a name="l00284"></a>00284                         <span class="keywordflow">return</span>;
<a name="l00285"></a>00285                 }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                 <span class="keywordflow">try</span>
<a name="l00288"></a>00288                 {
<a name="l00289"></a>00289                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a117d10e81e82e30311c0cfc021ad67f9">babudb</a>.shutdown( <span class="keyword">true</span> );
<a name="l00290"></a>00290                 }
<a name="l00291"></a>00291                 <span class="keywordflow">catch</span>( BabuDBException e )
<a name="l00292"></a>00292                 {
<a name="l00293"></a>00293                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.warn( <span class="stringliteral">&quot;BabuDirectory could not shutdown: &quot;</span> + e.getMessage() );
<a name="l00294"></a>00294                         <span class="keywordflow">try</span>
<a name="l00295"></a>00295                         {
<a name="l00296"></a>00296                                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a117d10e81e82e30311c0cfc021ad67f9">babudb</a>.shutdown( <span class="keyword">false</span> );
<a name="l00297"></a>00297                         }
<a name="l00298"></a>00298                         <span class="keywordflow">catch</span>( BabuDBException e2 )
<a name="l00299"></a>00299                         {
<a name="l00300"></a>00300                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( <span class="stringliteral">&quot;BabuDirectory could even not forcefully shutdown.&quot;</span>, e2 );
<a name="l00301"></a>00301                         }
<a name="l00302"></a>00302                 }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae4d2f4e90a3c48219db1cd027a8cb708">opened</a> = <span class="keyword">false</span>;
<a name="l00305"></a>00305                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.info( <span class="stringliteral">&quot;BabuDirectory closed.&quot;</span> );
<a name="l00306"></a>00306         }
<a name="l00307"></a>00307 
<a name="l00313"></a>00313         @Override
<a name="l00314"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf">00314</a>         <span class="keyword">public</span> <span class="keywordtype">boolean</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf" title="Query the state of the database.">isopen</a>( )
<a name="l00315"></a>00315         {
<a name="l00316"></a>00316                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae4d2f4e90a3c48219db1cd027a8cb708">opened</a>;
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318 
<a name="l00330"></a>00330         @Override
<a name="l00331"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae0162de7d689a6f155e977cc6a2c556c">00331</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae0162de7d689a6f155e977cc6a2c556c" title="Insert a key with its set of values into a partition.">insert</a>( <span class="keywordtype">int</span> partition, List&lt; String &gt; key, List&lt; String &gt; value )
<a name="l00332"></a>00332         {
<a name="l00333"></a>00333                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.trace( <span class="stringliteral">&quot;Insert: &quot;</span> + partition + <span class="stringliteral">&quot;:&#39;&quot;</span> + key.toString() + <span class="stringliteral">&quot;&#39; -&gt; &#39;&quot;</span> + value.toString() + <span class="stringliteral">&quot;&#39;&quot;</span> );
<a name="l00334"></a>00334 
<a name="l00335"></a>00335                 <span class="comment">// guard</span>
<a name="l00336"></a>00336                 {
<a name="l00337"></a>00337                         <span class="keywordflow">if</span>( ! <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf" title="Query the state of the database.">isopen</a>() )
<a name="l00338"></a>00338                         {
<a name="l00339"></a>00339                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( <span class="stringliteral">&quot;Tried to operate on closed database.&quot;</span> );
<a name="l00340"></a>00340                         }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342                         <span class="keywordflow">if</span>( partition &lt; 0 )
<a name="l00343"></a>00343                         {
<a name="l00344"></a>00344                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;BabuDirectory only has nonnegative partitions, thus &quot;</span> + partition + <span class="stringliteral">&quot; is an illegal argument.&quot;</span> );
<a name="l00345"></a>00345                         }
<a name="l00346"></a>00346                         <span class="keywordflow">if</span>( null == key )
<a name="l00347"></a>00347                         {
<a name="l00348"></a>00348                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;null is no valid key!&quot;</span> );
<a name="l00349"></a>00349                         }
<a name="l00350"></a>00350                         <span class="keywordflow">if</span>( null == value )
<a name="l00351"></a>00351                         {
<a name="l00352"></a>00352                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;null is no valid value! Use delete instead, to delete the key!&quot;</span> );
<a name="l00353"></a>00353                         }
<a name="l00354"></a>00354                 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356                 byte[] _key = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a362e3723ce04b3fdc3947a6b2d972459" title="Convert a directory (interface language) to a byte array (backend language).">_buildkey</a>( key );
<a name="l00357"></a>00357                 byte[] _value = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a362e3723ce04b3fdc3947a6b2d972459" title="Convert a directory (interface language) to a byte array (backend language).">_buildkey</a>( value );
<a name="l00358"></a>00358                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae0162de7d689a6f155e977cc6a2c556c" title="Insert a key with its set of values into a partition.">insert</a>( partition, _key, _value );
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360 
<a name="l00369"></a>00369         @Override
<a name="l00370"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a12fae30adff934711b3145ac4c078cf8">00370</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <span class="keyword">delete</span>( <span class="keywordtype">int</span> partition, List&lt; String &gt; key )
<a name="l00371"></a>00371         {
<a name="l00372"></a>00372                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.trace( <span class="stringliteral">&quot;Delete: &quot;</span> + partition + <span class="stringliteral">&quot;:&#39;&quot;</span> + key.toString() + <span class="stringliteral">&quot;&#39;&quot;</span> );
<a name="l00373"></a>00373 
<a name="l00374"></a>00374                 byte[] _key;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376                 <span class="comment">// guard</span>
<a name="l00377"></a>00377                 {
<a name="l00378"></a>00378                         <span class="keywordflow">if</span>( ! <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf" title="Query the state of the database.">isopen</a>() )
<a name="l00379"></a>00379                         {
<a name="l00380"></a>00380                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( <span class="stringliteral">&quot;Tried to operate on closed database.&quot;</span> );
<a name="l00381"></a>00381                         }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383                         <span class="keywordflow">if</span>( partition &lt; 0 )
<a name="l00384"></a>00384                         {
<a name="l00385"></a>00385                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;BabuDirectory only has nonnegative partitions, thus &quot;</span> + partition + <span class="stringliteral">&quot; is an illegal argument.&quot;</span> );
<a name="l00386"></a>00386                         }
<a name="l00387"></a>00387                         <span class="keywordflow">if</span>( null == key )
<a name="l00388"></a>00388                         {
<a name="l00389"></a>00389                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;null is no valid key!&quot;</span> );
<a name="l00390"></a>00390                         }
<a name="l00391"></a>00391                 }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393                 _key = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a362e3723ce04b3fdc3947a6b2d972459" title="Convert a directory (interface language) to a byte array (backend language).">_buildkey</a>( key );
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae0162de7d689a6f155e977cc6a2c556c" title="Insert a key with its set of values into a partition.">insert</a>( partition, _key, null );
<a name="l00396"></a>00396         }
<a name="l00397"></a>00397 
<a name="l00407"></a>00407         @Override
<a name="l00408"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae036dc2beba1cf6e5eed9592cb0286bf">00408</a>         <span class="keyword">public</span> Map&lt; List&lt; String &gt;, List&lt; String &gt; &gt; <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae036dc2beba1cf6e5eed9592cb0286bf" title="Query the entries with all keys beginning with a prefix.">prefixlookup</a>( <span class="keywordtype">int</span> partition, List&lt; String &gt; prefix )
<a name="l00409"></a>00409         {
<a name="l00410"></a>00410                 <span class="comment">// guard</span>
<a name="l00411"></a>00411                 {
<a name="l00412"></a>00412                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.trace( <span class="stringliteral">&quot;PrefixLookup: &quot;</span> + partition + <span class="stringliteral">&quot;:&#39;&quot;</span> + prefix.toString() + <span class="stringliteral">&quot;&#39;&quot;</span> );
<a name="l00413"></a>00413 
<a name="l00414"></a>00414                         <span class="keywordflow">if</span>( ! <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf" title="Query the state of the database.">isopen</a>() )
<a name="l00415"></a>00415                         {
<a name="l00416"></a>00416                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( <span class="stringliteral">&quot;Tried to operate on closed database.&quot;</span> );
<a name="l00417"></a>00417                         }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419                         <span class="keywordflow">if</span>( partition &lt; 0 )
<a name="l00420"></a>00420                         {
<a name="l00421"></a>00421                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;BabuDirectory only has nonnegative partitions, thus &quot;</span> + partition + <span class="stringliteral">&quot; is an illegal argument.&quot;</span> );
<a name="l00422"></a>00422                         }
<a name="l00423"></a>00423                         <span class="keywordflow">if</span>( null == prefix )
<a name="l00424"></a>00424                         {
<a name="l00425"></a>00425                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;null is no valid key!&quot;</span> );
<a name="l00426"></a>00426                         }
<a name="l00427"></a>00427                 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429                 Map&lt; List&lt; String &gt;, List&lt; String &gt; &gt; map = <span class="keyword">new</span> HashMap&lt; List&lt; String &gt;, List&lt; String &gt; &gt;();
<a name="l00430"></a>00430 
<a name="l00431"></a>00431                 byte[] _prefix;
<a name="l00432"></a>00432                 _prefix = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a362e3723ce04b3fdc3947a6b2d972459" title="Convert a directory (interface language) to a byte array (backend language).">_buildkey</a>( prefix );
<a name="l00433"></a>00433 
<a name="l00434"></a>00434                 Map&lt; byte[], byte[] &gt; _map;
<a name="l00435"></a>00435                 _map = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae036dc2beba1cf6e5eed9592cb0286bf" title="Query the entries with all keys beginning with a prefix.">prefixlookup</a>( partition, _prefix );
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                 <span class="comment">// transform results from BabuDB</span>
<a name="l00438"></a>00438                 {
<a name="l00439"></a>00439                         <span class="keywordflow">for</span>( Entry&lt; byte[], byte[] &gt; entry: _map.entrySet() )
<a name="l00440"></a>00440                         {
<a name="l00441"></a>00441                                 <span class="keywordflow">if</span>( null == entry.getKey() || null == entry.getValue() )
<a name="l00442"></a>00442                                 {
<a name="l00443"></a>00443                                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( <span class="stringliteral">&quot;Internal error: got null prefix or value from BabuDB.&quot;</span> );
<a name="l00444"></a>00444                                 }
<a name="l00445"></a>00445                                 map.put( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1f0d7074ae9b98d203303f0f3bf67944" title="Convert a byte array (backend language) to a directory (interface language).">buildkey</a>( entry.getKey() ), <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1f0d7074ae9b98d203303f0f3bf67944" title="Convert a byte array (backend language) to a directory (interface language).">buildkey</a>( entry.getValue() ) );
<a name="l00446"></a>00446                         }
<a name="l00447"></a>00447                 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449                 <span class="keywordflow">return</span> map;
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451 
<a name="l00459"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a8c5aba04d73bdd0f2358fee94f2eec72">00459</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae0162de7d689a6f155e977cc6a2c556c" title="Insert a key with its set of values into a partition.">insert</a>( <span class="keywordtype">int</span> partition, byte[] key, byte[] value )
<a name="l00460"></a>00460         {
<a name="l00461"></a>00461                 <span class="comment">// guard</span>
<a name="l00462"></a>00462                 {
<a name="l00463"></a>00463                         <span class="keywordflow">if</span>( partition &lt; 0 )
<a name="l00464"></a>00464                         {
<a name="l00465"></a>00465                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;BabuDirectory only has nonnegative partitions, thus &quot;</span> + partition + <span class="stringliteral">&quot; is an illegal argument.&quot;</span> );
<a name="l00466"></a>00466                         }
<a name="l00467"></a>00467                         <span class="keywordflow">if</span>( null == key )
<a name="l00468"></a>00468                         {
<a name="l00469"></a>00469                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;null is no valid key!&quot;</span> );
<a name="l00470"></a>00470                         }
<a name="l00471"></a>00471                 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a10b58bc5d127ec95d460b8b21cfa1c7a">db</a>.singleInsert( partition, key, value, null );
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475 
<a name="l00488"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ac257d3fd31dcad41d9cffbbad383904e">00488</a>         <span class="keyword">private</span> Map&lt; byte[], byte[] &gt; <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#ae036dc2beba1cf6e5eed9592cb0286bf" title="Query the entries with all keys beginning with a prefix.">prefixlookup</a>( <span class="keywordtype">int</span> partition, byte[] key )
<a name="l00489"></a>00489         {
<a name="l00490"></a>00490                 <span class="comment">// guard</span>
<a name="l00491"></a>00491                 {
<a name="l00492"></a>00492                         <span class="keywordflow">if</span>( partition &lt; 0 )
<a name="l00493"></a>00493                         {
<a name="l00494"></a>00494                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;BabuDirectory only has nonnegative partitions, thus &quot;</span> + partition + <span class="stringliteral">&quot; is an illegal argument.&quot;</span> );
<a name="l00495"></a>00495                         }
<a name="l00496"></a>00496                         <span class="keywordflow">if</span>( null == key )
<a name="l00497"></a>00497                         {
<a name="l00498"></a>00498                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;null is no valid key!&quot;</span> );
<a name="l00499"></a>00499                         }
<a name="l00500"></a>00500                 }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502                 Map&lt; byte[], byte[] &gt; map = <span class="keyword">new</span> HashMap&lt; byte[], byte[] &gt;();
<a name="l00503"></a>00503 
<a name="l00504"></a>00504                 <span class="comment">// wait synchronously and return fill list</span>
<a name="l00505"></a>00505                 {
<a name="l00506"></a>00506                         <span class="keywordflow">try</span>
<a name="l00507"></a>00507                         {
<a name="l00508"></a>00508                                 DatabaseRequestResult&lt; ResultSet&lt; byte[], byte[] &gt; &gt; req;
<a name="l00509"></a>00509                                 req = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a10b58bc5d127ec95d460b8b21cfa1c7a">db</a>.prefixLookup( partition, key, null );
<a name="l00510"></a>00510 
<a name="l00511"></a>00511                                 ResultSet&lt; byte[], byte[] &gt; res = req.get( );
<a name="l00512"></a>00512 
<a name="l00513"></a>00513                                 <span class="keywordflow">while</span>( res.hasNext() )
<a name="l00514"></a>00514                                 {
<a name="l00515"></a>00515                                         Entry&lt; byte[], byte[] &gt; entry = res.next();
<a name="l00516"></a>00516                                         map.put( entry.getKey(), entry.getValue() );
<a name="l00517"></a>00517                                 }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519                                 res.free();
<a name="l00520"></a>00520                         }
<a name="l00521"></a>00521                         <span class="keywordflow">catch</span>( BabuDBException e )
<a name="l00522"></a>00522                         {
<a name="l00523"></a>00523                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e );
<a name="l00524"></a>00524                         }
<a name="l00525"></a>00525                 }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527                 <span class="keywordflow">return</span> map;
<a name="l00528"></a>00528         }
<a name="l00529"></a>00529 
<a name="l00541"></a>00541         @Override
<a name="l00542"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a2037aad9993b277ec2f0c6d814497575">00542</a>         <span class="keyword">public</span> List&lt; String &gt; <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a2037aad9993b277ec2f0c6d814497575" title="Query the values for a key in a partition.">lookup</a>( <span class="keywordtype">int</span> partition, List&lt; String &gt; key )
<a name="l00543"></a>00543         {
<a name="l00544"></a>00544                 <span class="comment">// guard</span>
<a name="l00545"></a>00545                 {
<a name="l00546"></a>00546                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1c3edcf59e8a4cc08cf5ff5d0eb4edae">log</a>.trace( <span class="stringliteral">&quot;Lookup: &quot;</span> + partition + <span class="stringliteral">&quot;:&#39;&quot;</span> + key.toString() + <span class="stringliteral">&quot;&#39;&quot;</span> );
<a name="l00547"></a>00547 
<a name="l00548"></a>00548                         <span class="keywordflow">if</span>( ! <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1950a3e631b25b4cc95ee9ef2dcbe5bf" title="Query the state of the database.">isopen</a>() )
<a name="l00549"></a>00549                         {
<a name="l00550"></a>00550                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( <span class="stringliteral">&quot;Tried to operate on closed database.&quot;</span> );
<a name="l00551"></a>00551                         }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553                         <span class="keywordflow">if</span>( partition &lt; 0 )
<a name="l00554"></a>00554                         {
<a name="l00555"></a>00555                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;BabuDirectory only has nonnegative partitions, thus &quot;</span> + partition + <span class="stringliteral">&quot; is an illegal argument&quot;</span> );
<a name="l00556"></a>00556                         }
<a name="l00557"></a>00557                         <span class="keywordflow">if</span>( null == key )
<a name="l00558"></a>00558                         {
<a name="l00559"></a>00559                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;null is no valid key!&quot;</span> );
<a name="l00560"></a>00560                         }
<a name="l00561"></a>00561                 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                 byte[] _key = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a362e3723ce04b3fdc3947a6b2d972459" title="Convert a directory (interface language) to a byte array (backend language).">_buildkey</a>( key );
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1f0d7074ae9b98d203303f0f3bf67944" title="Convert a byte array (backend language) to a directory (interface language).">buildkey</a>( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a2037aad9993b277ec2f0c6d814497575" title="Query the values for a key in a partition.">lookup</a>( partition, _key ) );
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567 
<a name="l00579"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a9137e781844e67415f8a82f427d613f4">00579</a>         <span class="keyword">private</span> byte[] <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a2037aad9993b277ec2f0c6d814497575" title="Query the values for a key in a partition.">lookup</a>( <span class="keywordtype">int</span> partition, byte[] key )
<a name="l00580"></a>00580         {
<a name="l00581"></a>00581                 DatabaseRequestResult&lt; byte[] &gt; req;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583                 req = <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a10b58bc5d127ec95d460b8b21cfa1c7a">db</a>.lookup( partition, key, null );
<a name="l00584"></a>00584 
<a name="l00585"></a>00585                 <span class="comment">// wait synchronously and return fill list</span>
<a name="l00586"></a>00586                 {
<a name="l00587"></a>00587                         <span class="keywordflow">try</span>
<a name="l00588"></a>00588                         {
<a name="l00589"></a>00589                                 <span class="keywordflow">return</span> req.get( );
<a name="l00590"></a>00590                         }
<a name="l00591"></a>00591                         <span class="keywordflow">catch</span>( BabuDBException e )
<a name="l00592"></a>00592                         {
<a name="l00593"></a>00593                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e );
<a name="l00594"></a>00594                         }
<a name="l00595"></a>00595                 }
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597 
<a name="l00606"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a362e3723ce04b3fdc3947a6b2d972459">00606</a>         <span class="keyword">private</span> byte[] <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a362e3723ce04b3fdc3947a6b2d972459" title="Convert a directory (interface language) to a byte array (backend language).">_buildkey</a>( List&lt; String &gt; l )
<a name="l00607"></a>00607         {
<a name="l00608"></a>00608                 List&lt; String &gt; list = <span class="keyword">new</span> LinkedList&lt; String &gt;( l );
<a name="l00609"></a>00609 
<a name="l00610"></a>00610                 <span class="keywordflow">if</span>( null == list )
<a name="l00611"></a>00611                 {
<a name="l00612"></a>00612                         <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;Illegal argument null for &quot;</span> + this.getClass().getName() + <span class="stringliteral">&quot;._buildkey( list ). &quot;</span> );
<a name="l00613"></a>00613                 }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                 <span class="comment">// sum up the size first</span>
<a name="l00616"></a>00616                 <span class="keywordtype">int</span> size = 0;
<a name="l00617"></a>00617                 {
<a name="l00618"></a>00618                         <span class="keywordflow">for</span>( String s: list )
<a name="l00619"></a>00619                         {
<a name="l00620"></a>00620                                 size += s.length()+1;
<a name="l00621"></a>00621                         }
<a name="l00622"></a>00622                 }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624                 <span class="keywordflow">if</span>( 0 == size )
<a name="l00625"></a>00625                         <span class="keywordflow">return</span> <span class="keyword">new</span> byte[0];
<a name="l00626"></a>00626 
<a name="l00627"></a>00627                 size--; <span class="comment">// remove the last &#39;\0&#39;</span>
<a name="l00628"></a>00628 
<a name="l00629"></a>00629                 byte[] result = <span class="keyword">new</span> byte[ size ];
<a name="l00630"></a>00630 
<a name="l00631"></a>00631                 <span class="comment">// append all strings of list to byte array</span>
<a name="l00632"></a>00632                 {
<a name="l00633"></a>00633                         <span class="keywordtype">int</span> offset = 0;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635                         byte[] _s;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637                         <span class="keywordflow">try</span>
<a name="l00638"></a>00638                         {
<a name="l00639"></a>00639                                 _s = list.remove( 0 ).getBytes( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a> );
<a name="l00640"></a>00640                         }
<a name="l00641"></a>00641                         <span class="keywordflow">catch</span>( UnsupportedEncodingException e )
<a name="l00642"></a>00642                         {
<a name="l00643"></a>00643                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e );
<a name="l00644"></a>00644                         }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646                         <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a3a4800cee3844b1dc490adbb7902d3b4" title="C-Style memcpy whereas the length is given by the src array.">byteCopy</a>( result, _s, offset );
<a name="l00647"></a>00647 
<a name="l00648"></a>00648                         offset += _s.length;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650                         <span class="keywordflow">for</span>( String s: list )
<a name="l00651"></a>00651                         {
<a name="l00652"></a>00652                                 result[ offset ] = 0;
<a name="l00653"></a>00653                                 offset++;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655                                 <span class="keywordflow">try</span>
<a name="l00656"></a>00656                                 {
<a name="l00657"></a>00657                                         _s = s.getBytes( <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a> );
<a name="l00658"></a>00658                                 }
<a name="l00659"></a>00659                                 <span class="keywordflow">catch</span>( UnsupportedEncodingException e )
<a name="l00660"></a>00660                                 {
<a name="l00661"></a>00661                                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e );
<a name="l00662"></a>00662                                 }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664                                 <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a3a4800cee3844b1dc490adbb7902d3b4" title="C-Style memcpy whereas the length is given by the src array.">byteCopy</a>( result, _s, offset );
<a name="l00665"></a>00665 
<a name="l00666"></a>00666                                 offset += s.length();
<a name="l00667"></a>00667                         }
<a name="l00668"></a>00668                 }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670                 <span class="keywordflow">return</span> result;
<a name="l00671"></a>00671         }
<a name="l00672"></a>00672 
<a name="l00681"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1f0d7074ae9b98d203303f0f3bf67944">00681</a>         <span class="keyword">private</span> List&lt; String &gt; <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a1f0d7074ae9b98d203303f0f3bf67944" title="Convert a byte array (backend language) to a directory (interface language).">buildkey</a>( byte[] _key )
<a name="l00682"></a>00682         {
<a name="l00683"></a>00683                 <span class="keywordflow">if</span>( null == _key )
<a name="l00684"></a>00684                         <span class="keywordflow">return</span> null;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686                 List&lt; String &gt; result = <span class="keyword">new</span> LinkedList&lt; String &gt;();
<a name="l00687"></a>00687 
<a name="l00688"></a>00688                 <span class="keywordtype">int</span> offset = 0;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690                 <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt;= _key.length; ++i )
<a name="l00691"></a>00691                 {
<a name="l00692"></a>00692                         <span class="keywordflow">if</span>( i == _key.length || 0 == _key[ i ] )
<a name="l00693"></a>00693                         {
<a name="l00694"></a>00694                                 <span class="keywordflow">try</span>
<a name="l00695"></a>00695                                 {
<a name="l00696"></a>00696                                         String s = <span class="keyword">new</span> String( _key, offset, i - offset, <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a861bbe5055462bb12a9a11a3d9c6216d">enc</a> );
<a name="l00697"></a>00697                                         result.add( s );
<a name="l00698"></a>00698                                 }
<a name="l00699"></a>00699                                 <span class="keywordflow">catch</span>( UnsupportedEncodingException e )
<a name="l00700"></a>00700                                 {
<a name="l00701"></a>00701                                         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a>( e );
<a name="l00702"></a>00702                                 }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704                                 offset = i+1;
<a name="l00705"></a>00705                         }
<a name="l00706"></a>00706                 }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708                 <span class="keywordflow">return</span> result;
<a name="l00709"></a>00709         }
<a name="l00710"></a>00710 
<a name="l00716"></a><a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a3a4800cee3844b1dc490adbb7902d3b4">00716</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d76/classde_1_1zib_1_1vold_1_1backend_1_1BabuDirectory.html#a3a4800cee3844b1dc490adbb7902d3b4" title="C-Style memcpy whereas the length is given by the src array.">byteCopy</a>( byte[] dest, byte[] src, <span class="keywordtype">int</span> offset )
<a name="l00717"></a>00717         {
<a name="l00718"></a>00718                 <span class="keywordflow">if</span>( offset &lt; 0 || dest.length-offset &lt; src.length )
<a name="l00719"></a>00719                 {
<a name="l00720"></a>00720                         <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;Not enough space to copy source to destination at given offset.&quot;</span> );
<a name="l00721"></a>00721                 }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723                 <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; src.length; ++i )
<a name="l00724"></a>00724                 {
<a name="l00725"></a>00725                         dest[ offset+i ] = src[ i ];
<a name="l00726"></a>00726                 }
<a name="l00727"></a>00727         }
<a name="l00728"></a>00728 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d7/d6d/BabuDirectory_8java.html">BabuDirectory.java</a>      </li>
      <li class="footer">Generated on Tue Nov 29 2011 19:01:41 for VolD by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>

</body>
</html>
