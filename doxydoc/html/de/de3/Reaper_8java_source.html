<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>VolD: server/src/main/java/de/zib/vold/frontend/Reaper.java Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = '../../open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = '../../closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">VolD&#160;<span id="projectnumber">0.1</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../namespaces.html"><span>Packages</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('de/de3/Reaper_8java.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Reaper.java</h1>  </div>
</div>
<div class="contents">
<a href="../../de/de3/Reaper_8java.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="keyword">package </span>de.zib.vold.frontend;
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="keyword">import</span> de.zib.vold.common.VoldException;
<a name="l00005"></a>00005 <span class="keyword">import</span> de.zib.vold.volatilelogic.SlicedDirectory;
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">import</span> java.util.List;
<a name="l00008"></a>00008 <span class="keyword">import</span> java.util.Map;
<a name="l00009"></a>00009 <span class="keyword">import</span> org.joda.time.DateTime;
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="keyword">import</span> javax.annotation.PostConstruct;
<a name="l00012"></a>00012 <span class="keyword">import</span> javax.annotation.PreDestroy;
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="keyword">import</span> org.slf4j.Logger;
<a name="l00015"></a>00015 <span class="keyword">import</span> org.slf4j.LoggerFactory;
<a name="l00016"></a>00016 
<a name="l00024"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html">00024</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html" title="GarbageCollector for VolD.">Reaper</a> <span class="keyword">extends</span> Thread
<a name="l00025"></a>00025 {
<a name="l00026"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#ac83ccc181955356b147191fca387f532">00026</a>         <span class="keyword">private</span> <span class="keywordtype">boolean</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#ac83ccc181955356b147191fca387f532">run</a>;
<a name="l00027"></a>00027         <span class="comment">//</span>
<a name="l00028"></a>00028         <span class="comment">// time to live in milliseconds</span>
<a name="l00029"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">00029</a>         <span class="keyword">private</span> <span class="keywordtype">long</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">ttl</a>;
<a name="l00030"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">00030</a>         <span class="keyword">private</span> <a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html" title="Interface for Backends with slice information.">SlicedDirectory</a> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a>;
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">00032</a>         <span class="keyword">protected</span> <span class="keyword">final</span> Logger <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a> = LoggerFactory.getLogger( this.getClass() );
<a name="l00033"></a>00033 
<a name="l00040"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a47e66b8eec1555d15f8996f86113162a">00040</a>         <span class="keyword">public</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a025c48f09bca484136b1025de5d87395" title="Construct an uninitialized Reaper.">Reaper</a>( <a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html" title="Interface for Backends with slice information.">SlicedDirectory</a> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a>, <span class="keywordtype">long</span> TTL )
<a name="l00041"></a>00041         {
<a name="l00042"></a>00042                 <span class="keywordflow">if</span>( null == directory )
<a name="l00043"></a>00043                 {
<a name="l00044"></a>00044                         <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;Reaper needs a SlicedDirectory, but null has been given!&quot;</span> );
<a name="l00045"></a>00045                 }
<a name="l00046"></a>00046                 <span class="keywordflow">if</span>( TTL &lt; 0 )
<a name="l00047"></a>00047                 {
<a name="l00048"></a>00048                         <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;ReaperWorker needs nonnegative TTL to count with, but TTL=&quot;</span> + TTL + <span class="stringliteral">&quot; has been given!&quot;</span> );
<a name="l00049"></a>00049                 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">ttl</a> = TTL;
<a name="l00052"></a>00052                 this.directory = <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a>;
<a name="l00053"></a>00053                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a00d8f227273f698633b6db10ff37ebe9" title="Start the reaper in foreground.">run</a> = <span class="keyword">false</span>;
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055 
<a name="l00059"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a025c48f09bca484136b1025de5d87395">00059</a>         <span class="keyword">public</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a025c48f09bca484136b1025de5d87395" title="Construct an uninitialized Reaper.">Reaper</a>( )
<a name="l00060"></a>00060         {
<a name="l00061"></a>00061                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">ttl</a> = -1;
<a name="l00062"></a>00062                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a> = null;
<a name="l00063"></a>00063                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a00d8f227273f698633b6db10ff37ebe9" title="Start the reaper in foreground.">run</a> = <span class="keyword">false</span>;
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065 
<a name="l00069"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a4389ae9d5718cd791035bd8f86191c02">00069</a>         <span class="keyword">protected</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a4389ae9d5718cd791035bd8f86191c02" title="Internal method which acts as part of the guard of all public methods.">checkState</a>( )
<a name="l00070"></a>00070         {
<a name="l00071"></a>00071                 <span class="keywordflow">if</span>( this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">ttl</a> &lt; 0 || null == this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a> )
<a name="l00072"></a>00072                 {
<a name="l00073"></a>00073                         <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalStateException( <span class="stringliteral">&quot;Reaper cannot work while it had not been initialized properly yet. You first need to set a Directory to reap and the appropriate time to live (TTL)!&quot;</span> );
<a name="l00074"></a>00074                 }
<a name="l00075"></a>00075         }
<a name="l00076"></a>00076 
<a name="l00082"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#ab863576919fcdc56082491fe37380a79">00082</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#ab863576919fcdc56082491fe37380a79" title="Set the time a key may live.">setTTL</a>( <span class="keywordtype">long</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">ttl</a> )
<a name="l00083"></a>00083         {
<a name="l00084"></a>00084                 <span class="keywordflow">if</span>( ttl &lt;= 0 )
<a name="l00085"></a>00085                 {
<a name="l00086"></a>00086                         <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;ReaperWorker needs positive TTL to count with, but TTL=&quot;</span> + ttl + <span class="stringliteral">&quot; has been given!&quot;</span> );
<a name="l00087"></a>00087                 }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089                 this.ttl = <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">ttl</a>;
<a name="l00090"></a>00090         }
<a name="l00091"></a>00091 
<a name="l00095"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a3ffe95a259deb101755a9efcf3a51fe1">00095</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a3ffe95a259deb101755a9efcf3a51fe1" title="Set the directory the Reaper should work on.">setSlicedDirectory</a>( <a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html" title="Interface for Backends with slice information.">SlicedDirectory</a> slicedDirectory )
<a name="l00096"></a>00096         {
<a name="l00097"></a>00097                 <span class="keywordflow">if</span>( null != this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a> )
<a name="l00098"></a>00098                 {
<a name="l00099"></a>00099                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.warn( <span class="stringliteral">&quot;Directory to reap changed!&quot;</span> );
<a name="l00100"></a>00100                 }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a> = slicedDirectory;
<a name="l00103"></a>00103         }
<a name="l00104"></a>00104 
<a name="l00108"></a>00108         @PreDestroy
<a name="l00109"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a493288705358506fad7a64456c0c70fc">00109</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a493288705358506fad7a64456c0c70fc" title="Stop the thread running in the background.">stop_service</a>( )
<a name="l00110"></a>00110         {
<a name="l00111"></a>00111                 <span class="comment">// guard</span>
<a name="l00112"></a>00112                 {
<a name="l00113"></a>00113                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a4389ae9d5718cd791035bd8f86191c02" title="Internal method which acts as part of the guard of all public methods.">checkState</a>();
<a name="l00114"></a>00114                 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a00d8f227273f698633b6db10ff37ebe9" title="Start the reaper in foreground.">run</a> = <span class="keyword">false</span>;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118                 <span class="keywordflow">try</span>
<a name="l00119"></a>00119                 {
<a name="l00120"></a>00120                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.info( <span class="stringliteral">&quot;Stopping Reaper...&quot;</span> );
<a name="l00121"></a>00121                         this.join();
<a name="l00122"></a>00122                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.info( <span class="stringliteral">&quot;Reaper stoped.&quot;</span> );
<a name="l00123"></a>00123                 }
<a name="l00124"></a>00124                 <span class="keywordflow">catch</span>( InterruptedException e )
<a name="l00125"></a>00125                 {
<a name="l00126"></a>00126                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.warn( <span class="stringliteral">&quot;Could not wait for Reaper to stop: &quot;</span> + e.getMessage() );
<a name="l00127"></a>00127                 }
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129 
<a name="l00133"></a>00133         @PostConstruct
<a name="l00134"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9343b5786150a7a640a53f66bbdb2875">00134</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9343b5786150a7a640a53f66bbdb2875" title="Start the Reaper in background.">start</a>()
<a name="l00135"></a>00135         {
<a name="l00136"></a>00136                 super.start();
<a name="l00137"></a>00137         }
<a name="l00138"></a>00138 
<a name="l00142"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a00d8f227273f698633b6db10ff37ebe9">00142</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a00d8f227273f698633b6db10ff37ebe9" title="Start the reaper in foreground.">run</a>()
<a name="l00143"></a>00143         {
<a name="l00144"></a>00144                 <span class="comment">// guard</span>
<a name="l00145"></a>00145                 {
<a name="l00146"></a>00146                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a4389ae9d5718cd791035bd8f86191c02" title="Internal method which acts as part of the guard of all public methods.">checkState</a>();
<a name="l00147"></a>00147                 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149                 this.<a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a00d8f227273f698633b6db10ff37ebe9" title="Start the reaper in foreground.">run</a> = <span class="keyword">true</span>;
<a name="l00150"></a>00150                 <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0fb24d8fda7a919912fe14cc5174aed1" title="Work until the run flag is set to false.">reap</a>();
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152 
<a name="l00156"></a><a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0fb24d8fda7a919912fe14cc5174aed1">00156</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0fb24d8fda7a919912fe14cc5174aed1" title="Work until the run flag is set to false.">reap</a>( )
<a name="l00157"></a>00157         {
<a name="l00158"></a>00158                 <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.info( <span class="stringliteral">&quot;Reaper started.&quot;</span> );
<a name="l00159"></a>00159 
<a name="l00160"></a>00160                 <span class="comment">// guard</span>
<a name="l00161"></a>00161                 {
<a name="l00162"></a>00162                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a4389ae9d5718cd791035bd8f86191c02" title="Internal method which acts as part of the guard of all public methods.">checkState</a>();
<a name="l00163"></a>00163                 }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 
<a name="l00166"></a>00166                 <span class="keywordflow">while</span>( <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a00d8f227273f698633b6db10ff37ebe9" title="Start the reaper in foreground.">run</a> )
<a name="l00167"></a>00167                 {
<a name="l00168"></a>00168                         <span class="keywordtype">long</span> actslice = <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a>.<a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html#ae589d77510341ca9425b6d34ad1e420a" title="Returns the slice number for the actual time.">getActualSlice</a>();
<a name="l00169"></a>00169                         <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html" title="The Worker class for the reaper.">ReaperWorker</a> worker = <span class="keyword">new</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html" title="The Worker class for the reaper.">ReaperWorker</a>( <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a>, actslice, <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a9de6231cfdf1ad0281a36e726b345469">ttl</a> );
<a name="l00170"></a>00170 
<a name="l00171"></a>00171                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.trace( <span class="stringliteral">&quot;Reaping timeslice &quot;</span> + actslice + <span class="stringliteral">&quot;...&quot;</span> );
<a name="l00172"></a>00172 
<a name="l00173"></a>00173                         <span class="comment">// start thread on reap_timeslice</span>
<a name="l00174"></a>00174                         {
<a name="l00175"></a>00175                                 worker.start();
<a name="l00176"></a>00176                         }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178                         <span class="keywordflow">try</span>
<a name="l00179"></a>00179                         {
<a name="l00180"></a>00180                                 sleep( <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a2a906dc3ce1660881eb3028eedc04aa6">directory</a>.<a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html#af3ce4fe04779f5de4161ad20075f14b3" title="Get the size of one slice in milliseconds.">getTimeSliceSize</a>() );
<a name="l00181"></a>00181                         }
<a name="l00182"></a>00182                         <span class="keywordflow">catch</span>( InterruptedException e )
<a name="l00183"></a>00183                         {
<a name="l00184"></a>00184                                 <span class="comment">// Log message, but keep working</span>
<a name="l00185"></a>00185                                 <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.error( <span class="stringliteral">&quot;Interrupted during sleep for one timeslice: &quot;</span> + e.getMessage() );
<a name="l00186"></a>00186                         }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188                         <span class="comment">// wait for reap to finish</span>
<a name="l00189"></a>00189                         {
<a name="l00190"></a>00190                                 <span class="keywordflow">try</span>
<a name="l00191"></a>00191                                 {
<a name="l00192"></a>00192                                         worker.join();
<a name="l00193"></a>00193                                 }
<a name="l00194"></a>00194                                 <span class="keywordflow">catch</span>( InterruptedException e )
<a name="l00195"></a>00195                                 {
<a name="l00196"></a>00196                                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.error( <span class="stringliteral">&quot;Interrupted while waiting for ReaperWorker on timeslice &quot;</span> + actslice + <span class="stringliteral">&quot;: &quot;</span> + e.getMessage() );
<a name="l00197"></a>00197                                 }
<a name="l00198"></a>00198                         }
<a name="l00199"></a>00199                 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201                 <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.info( <span class="stringliteral">&quot;Reaper finished working.&quot;</span> );
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203 
<a name="l00209"></a><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html">00209</a>         <span class="keyword">private</span> <span class="keyword">class </span><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html" title="The Worker class for the reaper.">ReaperWorker</a> <span class="keyword">extends</span> Thread
<a name="l00210"></a>00210         {
<a name="l00211"></a><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ab271ba8af082ab4c0f4b3052b92cef2b">00211</a>                 <span class="keyword">private</span> <a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html" title="Interface for Backends with slice information.">SlicedDirectory</a> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ab271ba8af082ab4c0f4b3052b92cef2b">directory</a>;
<a name="l00212"></a><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ac08ec45d0d28893807a29de76f95286c">00212</a>                 <span class="keyword">private</span> <span class="keywordtype">long</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ac08ec45d0d28893807a29de76f95286c">timeslice</a>;
<a name="l00213"></a><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ad9eb3474a0bb26c1ffce4df1c475b2f3">00213</a>                 <span class="keyword">private</span> <span class="keywordtype">long</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ad9eb3474a0bb26c1ffce4df1c475b2f3">ttl</a>;
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#a657fcb94dc53ebb25a41c1c6ef665288">00215</a>                 <span class="keyword">public</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#a657fcb94dc53ebb25a41c1c6ef665288">ReaperWorker</a>( <a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html" title="Interface for Backends with slice information.">SlicedDirectory</a> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ab271ba8af082ab4c0f4b3052b92cef2b">directory</a>, <span class="keywordtype">long</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ac08ec45d0d28893807a29de76f95286c">timeslice</a>, <span class="keywordtype">long</span> TTL )
<a name="l00216"></a>00216                 {
<a name="l00217"></a>00217                         <span class="keywordflow">if</span>( null == directory )
<a name="l00218"></a>00218                         {
<a name="l00219"></a>00219                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;ReaperWorker needs a SlicedDirectory, but null was given!&quot;</span> );
<a name="l00220"></a>00220                         }
<a name="l00221"></a>00221                         <span class="keywordflow">if</span>( timeslice &lt; 0 || TTL &lt; 0 )
<a name="l00222"></a>00222                         {
<a name="l00223"></a>00223                                 <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;ReaperWorker needs nonnegative timeslice to reap for elements with nonnegative TTL, but timeslice=&quot;</span> + timeslice + <span class="stringliteral">&quot; and TTL=&quot;</span> + TTL + <span class="stringliteral">&quot; was given!&quot;</span> );
<a name="l00224"></a>00224                         }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226                         this.directory = <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ab271ba8af082ab4c0f4b3052b92cef2b">directory</a>;
<a name="l00227"></a>00227                         this.timeslice = <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ac08ec45d0d28893807a29de76f95286c">timeslice</a>;
<a name="l00228"></a>00228                         this.<a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ad9eb3474a0bb26c1ffce4df1c475b2f3">ttl</a> = TTL;
<a name="l00229"></a>00229                 }
<a name="l00230"></a>00230 
<a name="l00231"></a><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#abd595cc2a1df4a14d92c248540231e01">00231</a>                 <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#abd595cc2a1df4a14d92c248540231e01">run</a>( )
<a name="l00232"></a>00232                 {
<a name="l00233"></a>00233                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.trace( <span class="stringliteral">&quot;ReaperWorker starting on timeslice &quot;</span> + String.valueOf( <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ac08ec45d0d28893807a29de76f95286c">timeslice</a> ) + <span class="stringliteral">&quot;...&quot;</span> );
<a name="l00234"></a>00234 
<a name="l00235"></a>00235                         <span class="keywordflow">try</span>
<a name="l00236"></a>00236                         {
<a name="l00237"></a>00237                                 <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#a3cab7a498c1d535a4a02f211a6376757">reap_timeslice</a>( <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ac08ec45d0d28893807a29de76f95286c">timeslice</a> );
<a name="l00238"></a>00238                         }
<a name="l00239"></a>00239                         <span class="keywordflow">catch</span>( <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a> e )
<a name="l00240"></a>00240                         {
<a name="l00241"></a>00241                                 <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.error( e.getMessage() );
<a name="l00242"></a>00242                                 <span class="keywordflow">return</span>;
<a name="l00243"></a>00243                         }
<a name="l00244"></a>00244                 }
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#a3cab7a498c1d535a4a02f211a6376757">00246</a>                 <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#a3cab7a498c1d535a4a02f211a6376757">reap_timeslice</a>( <span class="keywordtype">long</span> <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ac08ec45d0d28893807a29de76f95286c">timeslice</a> )
<a name="l00247"></a>00247                 {
<a name="l00248"></a>00248                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.trace( <span class="stringliteral">&quot;ReapTimeslice: &quot;</span> + timeslice );
<a name="l00249"></a>00249 
<a name="l00250"></a>00250                         <span class="comment">// guard</span>
<a name="l00251"></a>00251                         {
<a name="l00252"></a>00252                                 <span class="keywordflow">if</span>( timeslice &lt; 0 )
<a name="l00253"></a>00253                                 {
<a name="l00254"></a>00254                                         <span class="keywordflow">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="stringliteral">&quot;Cannot clean negative timeslices (&quot;</span> + timeslice + <span class="stringliteral">&quot;)!&quot;</span> );
<a name="l00255"></a>00255                                 }
<a name="l00256"></a>00256                         }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258                         Map&lt; List&lt; String &gt;, DateTime &gt; map = <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ab271ba8af082ab4c0f4b3052b92cef2b">directory</a>.<a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html#a2c09e174346b23f0f169c3f1b3d00a56" title="Query for all Key-insertiontime pairs of a given timeslice.">sliceLookup</a>( timeslice );
<a name="l00259"></a>00259 
<a name="l00260"></a>00260                         DateTime now = DateTime.now();
<a name="l00261"></a>00261 
<a name="l00262"></a>00262                         <span class="keywordtype">int</span> deleted = 0;
<a name="l00263"></a>00263                         <span class="keywordflow">for</span>( Map.Entry&lt; List&lt; String &gt;, DateTime &gt; entry: map.entrySet() )
<a name="l00264"></a>00264                         {
<a name="l00265"></a>00265                                 <span class="comment">// reap the element if it is too old</span>
<a name="l00266"></a>00266                                 <span class="keywordflow">if</span>( entry.getValue().plus( <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ad9eb3474a0bb26c1ffce4df1c475b2f3">ttl</a> ).isBefore( now ) )
<a name="l00267"></a>00267                                 {
<a name="l00268"></a>00268                                         <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.debug( <span class="stringliteral">&quot;Reaping key &quot;</span> + entry.getKey().toString() + <span class="stringliteral">&quot; with date of birth: &quot;</span> + entry.getValue() + <span class="stringliteral">&quot;.&quot;</span> );
<a name="l00269"></a>00269 
<a name="l00270"></a>00270                                         <span class="keywordflow">try</span>
<a name="l00271"></a>00271                                         {
<a name="l00272"></a>00272                                                 <a class="code" href="../../d7/d35/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper_1_1ReaperWorker.html#ab271ba8af082ab4c0f4b3052b92cef2b">directory</a>.<a class="code" href="../../d3/d1f/interfacede_1_1zib_1_1vold_1_1volatilelogic_1_1SlicedDirectory.html#ab217b4de04404f4b607bc1b6f43fee79" title="Delete a key.">delete</a>( entry.getKey() );
<a name="l00273"></a>00273                                                 ++deleted;
<a name="l00274"></a>00274                                         }
<a name="l00275"></a>00275                                         <span class="keywordflow">catch</span>( <a class="code" href="../../d7/d5c/classde_1_1zib_1_1vold_1_1common_1_1VoldException.html" title="The base for all exceptions thrown in VolD.">VoldException</a> e )
<a name="l00276"></a>00276                                         {
<a name="l00277"></a>00277                                                 <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.error( <span class="stringliteral">&quot;Could not reap key &quot;</span> + entry.getKey().toString() + <span class="stringliteral">&quot;. Reason: &quot;</span> + e.getMessage() );
<a name="l00278"></a>00278                                                 <span class="keywordflow">continue</span>;
<a name="l00279"></a>00279                                         }
<a name="l00280"></a>00280                                 }
<a name="l00281"></a>00281                         }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283                         <span class="keywordflow">if</span>( deleted &gt; 0 )
<a name="l00284"></a>00284                         {
<a name="l00285"></a>00285                                 <a class="code" href="../../d5/d04/classde_1_1zib_1_1vold_1_1frontend_1_1Reaper.html#a0ed0fbd84c0adebbe6f88f22fc81eabf">log</a>.debug( <span class="stringliteral">&quot;Reaper deleted &quot;</span> + String.valueOf( deleted ) + <span class="stringliteral">&quot; key(s) in timeslice &quot;</span> + timeslice + <span class="stringliteral">&quot;.&quot;</span> );
<a name="l00286"></a>00286                         }
<a name="l00287"></a>00287                 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../de/de3/Reaper_8java.html">Reaper.java</a>      </li>
      <li class="footer">Generated on Tue Nov 29 2011 19:01:41 for VolD by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>

</body>
</html>
